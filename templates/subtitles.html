{% extends "base.html" %}
{% block title %}<title>Субтитры</title>{% endblock %}
{% block content %}
<div class="bg-gray-100 min-h-screen flex flex-col mt-8">
  <section class="py-8">
    <div class="container mx-auto text-center px-4">
      <h1 class="text-4xl font-bold text-gray-800 mb-4">Добавление субтитров на видео</h1>
      <p class="text-xl text-gray-600 mb-4">Загрузите видеофайл длительностью не более 5 минут, чтобы сгенерировать субтитры.</p>
    </div>
  </section>
  <section class="bg-gray-100 w-full flex justify-center px-4">
    <div class="container mx-auto flex flex-col md:flex-row items-start">
      <div class="md:w-1/2 w-full mb-8 md:mb-0">
        <video id="video-preview" class="w-full h-auto rounded-lg shadow-md" controls></video>
      </div>
      <div class="md:w-1/2 w-full p-4">
        <form id="video-form" action="/subtitles_video" method="post" enctype="multipart/form-data" class="text-center">
          <div class="mb-8">
            <input type="file" name="video" id="video-file-input" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg w-full" accept="video/mp4" required onchange="validateVideoDuration(this)">
          </div>
          <div class="flex flex-col md:flex-row justify-center">
            <div class="mb-4 md:mr-4 md:ml-4 md:mb-0 w-full">
              <label for="video-language" class="block text-gray-700 text-sm font-bold mb-2">Язык видео:</label>
              <select name="video_language" id="video-language" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg w-full" required>
                <option value="" disabled selected>Выберите язык</option>
                <option value="af">Afrikaans</option>
                <option value="ar">Arabic</option>
                <option value="hy">Armenian</option>
                <option value="az">Azerbaijani</option>
                <option value="be">Belarusian</option>
                <option value="bs">Bosnian</option>
                <option value="bg">Bulgarian</option>
                <option value="ca">Catalan</option>
                <option value="zh">Chinese</option>
                <option value="hr">Croatian</option>
                <option value="cs">Czech</option>
                <option value="da">Danish</option>
                <option value="nl">Dutch</option>
                <option value="en">English</option>
                <option value="et">Estonian</option>
                <option value="fi">Finnish</option>
                <option value="fr">French</option>
                <option value="gl">Galician</option>
                <option value="de">German</option>
                <option value="el">Greek</option>
                <option value="he">Hebrew</option>
                <option value="hi">Hindi</option>
                <option value="hu">Hungarian</option>
                <option value="is">Icelandic</option>
                <option value="id">Indonesian</option>
                <option value="it">Italian</option>
                <option value="ja">Japanese</option>
                <option value="kn">Kannada</option>
                <option value="kk">Kazakh</option>
                <option value="ko">Korean</option>
                <option value="lv">Latvian</option>
                <option value="lt">Lithuanian</option>
                <option value="mk">Macedonian</option>
                <option value="ms">Malay</option>
                <option value="mr">Marathi</option>
                <option value="mi">Maori</option>
                <option value="ne">Nepali</option>
                <option value="no">Norwegian</option>
                <option value="fa">Persian</option>
                <option value="pl">Polish</option>
                <option value="pt">Portuguese</option>
                <option value="ro">Romanian</option>
                <option value="ru">Russian</option>
                <option value="sr">Serbian</option>
                <option value="sk">Slovak</option>
                <option value="sl">Slovenian</option>
                <option value="es">Spanish</option>
                <option value="sw">Swahili</option>
                <option value="sv">Swedish</option>
                <option value="tl">Tagalog</option>
                <option value="ta">Tamil</option>
                <option value="tt" selected>Tatar</option>
                <option value="th">Thai</option>
                <option value="tr">Turkish</option>
                <option value="uk">Ukrainian</option>
                <option value="ur">Urdu</option>
                <option value="vi">Vietnamese</option>
                <option value="cy">Welsh</option>
                </select>
              </select>
            </div>
            <div class="mb-4 md:mr-4 md:ml-4 md:mb-0 w-full">
              <label for="subtitles-language" class="block text-gray-700 text-sm font-bold mb-2 mt-4 md:mt-0">Язык субтитров:</label>
              <select name="subtitles_language" id="subtitles-language" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg w-full" required>
                <option value="" disabled selected>Выберите язык</option>
                <option value="af">Afrikaans</option>
                <option value="ar">Arabic</option>
                <option value="hy">Armenian</option>
                <option value="az">Azerbaijani</option>
                <option value="be">Belarusian</option>
                <option value="bs">Bosnian</option>
                <option value="bg">Bulgarian</option>
                <option value="ca">Catalan</option>
                <option value="zh">Chinese</option>
                <option value="hr">Croatian</option>
                <option value="cs">Czech</option>
                <option value="da">Danish</option>
                <option value="nl">Dutch</option>
                <option value="en">English</option>
                <option value="et">Estonian</option>
                <option value="fi">Finnish</option>
                <option value="fr">French</option>
                <option value="gl">Galician</option>
                <option value="de">German</option>
                <option value="el">Greek</option>
                <option value="he">Hebrew</option>
                <option value="hi">Hindi</option>
                <option value="hu">Hungarian</option>
                <option value="is">Icelandic</option>
                <option value="id">Indonesian</option>
                <option value="it">Italian</option>
                <option value="ja">Japanese</option>
                <option value="kn">Kannada</option>
                <option value="kk">Kazakh</option>
                <option value="ko">Korean</option>
                <option value="lv">Latvian</option>
                <option value="lt">Lithuanian</option>
                <option value="mk">Macedonian</option>
                <option value="ms">Malay</option>
                <option value="mr">Marathi</option>
                <option value="mi">Maori</option>
                <option value="ne">Nepali</option>
                <option value="no">Norwegian</option>
                <option value="fa">Persian</option>
                <option value="pl">Polish</option>
                <option value="pt">Portuguese</option>
                <option value="ro">Romanian</option>
                <option value="ru" selected>Russian</option>
                <option value="sr">Serbian</option>
                <option value="sk">Slovak</option>
                <option value="sl">Slovenian</option>
                <option value="es">Spanish</option>
                <option value="sw">Swahili</option>
                <option value="sv">Swedish</option>
                <option value="tl">Tagalog</option>
                <option value="ta">Tamil</option>
                <option value="tt">Tatar</option>
                <option value="th">Thai</option>
                <option value="tr">Turkish</option>
                <option value="uk">Ukrainian</option>
                <option value="ur">Urdu</option>
                <option value="vi">Vietnamese</option>
                <option value="cy">Welsh</option>
                </select>
              </select>
            </div>
          </div>
          <button type="submit" class="bg-green-800 text-white px-6 py-3 rounded-lg mt-6 w-full md:w-auto">Загрузить видео</button>
        </form>
      </div>
    </div>
  </section>
  
  <section class="bg-gray-100 w-full py-8">
    <div class="container mx-auto px-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Редактирование субтитров</h2>
      <div id="subtitles-container" class="mb-8">
      </div>
      <div class="flex flex-row  mb-4">
        <button type="button" id="prev-page" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Назад</button>
        <span id="page-info" class="text-gray-700 mx-2"></span>
        <button type="button" id="next-page" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Вперёд</button>
      </div>
    </div>
    <div class="container mx-auto px-4">
      <button type="button" id="save-subtitles" class="bg-green-800 text-white px-6 py-3 rounded-lg mt-4">Сохранить субтитры</button>
    </div>
  </section>
</div>

<script>
  function validateVideoDuration(input) {
    const video = input.files[0];
    const videoObject = document.createElement('video');

    videoObject.onloadedmetadata = function() {
        const duration = videoObject.duration;
        const maxDuration = 5 * 60; 

        if (duration > maxDuration) {
            alert('Пожалуйста, выберите видео длительностью не более 5 минут.');
            input.value = ''; 
        } else {
            const videoPreview = document.getElementById('video-preview');
            videoPreview.src = URL.createObjectURL(video);
        }
    };

    videoObject.src = URL.createObjectURL(video);
  }

  document.getElementById('video-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);

    const response = await fetch(form.action, {
      method: 'POST',
      body: formData,
    });

    const result = await response.json();
    if (result.success) {
      subtitles = result.subtitles;
      totalPages = Math.ceil(subtitles.length / itemsPerPage);
      video_path = result.video_path;
      subtitles_path = result.subtitles_path;
      renderSubtitles();
    } else {
      alert('Ошибка при загрузке видео.');
    }
  });

  let subtitles = [];
  let currentPage = 1;
  const itemsPerPage = 10;
  let totalPages = 1;
  let video_path = '';
  let subtitles_path = '';
  
  const renderSubtitles = () => {
    const subtitlesContainer = document.getElementById('subtitles-container');
    const startIdx = (currentPage - 1) * itemsPerPage;
    const endIdx = startIdx + itemsPerPage;
    const currentSubtitles = subtitles.slice(startIdx, endIdx);

    subtitlesContainer.innerHTML = '';
    currentSubtitles.forEach(subtitle => {
      const subtitleElement = document.createElement('div');

      const timeSpan = document.createElement('span');
      timeSpan.textContent = `${subtitle.start_time} - ${subtitle.end_time}: `;
      const textArea = document.createElement('textarea');
      textArea.value = subtitle.text;

      textArea.addEventListener('input', () => {
        subtitle.text = textArea.value;
      });

      subtitleElement.appendChild(timeSpan);
      subtitleElement.appendChild(textArea);
      subtitlesContainer.appendChild(subtitleElement);
    });
  };

  const goToPage = (page) => {
    if (page < 1 || page > totalPages) {
      return;
    }
    currentPage = page;
    renderSubtitles();
    updatePageInfo();
  };

  document.getElementById('prev-page').addEventListener('click', () => {
    goToPage(currentPage - 1);
  });

  document.getElementById('next-page').addEventListener('click', () => {
    goToPage(currentPage + 1);
  });

  document.getElementById('save-subtitles').addEventListener('click', async () => {
    const videoFileInput = document.getElementById('video-file-input');
    if (!videoFileInput.files.length) {
      alert('Пожалуйста, загрузите видеофайл.');
      return;
    }

    const videoFile = videoFileInput.files[0];
    const formData = new FormData();
    formData.append('video', videoFile);
    formData.append('subtitles', JSON.stringify(subtitles));
    formData.append('video_path', video_path);
    formData.append('subtitles_path', subtitles_path);

    const response = await fetch('/generate_subtitles', {
      method: 'POST',
      body: formData,
    });

    const result = await response.json();
    if (result.success) {
      alert('Субтитры успешно сохранены и добавлены на видео.');
    } else {
      alert('Ошибка при сохранении субтитров.');
    }
  });

  const updatePageInfo = () => {
    const pageInfo = document.getElementById('page-info');
    pageInfo.textContent = `Страница ${currentPage} из ${totalPages}`;
  };

</script>
{% endblock %}
